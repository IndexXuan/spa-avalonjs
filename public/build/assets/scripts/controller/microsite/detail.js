define([],function(){var apiBaseUrl=avalon.illyGlobal.apiBaseUrl,wx=(avalon.illyGlobal.token,avalon.wx),cachedPrefix="illy-microsite-detail-",resourcePrefix=avalon.illyGlobal.resourceBaseUrl,needCache=!0,detail=avalon.define({$id:"detail",visited:!1,articleId:1,title:"",image:"",content:"",createdTime:"2015-07-03",shareCount:88,visitCount:88,likeCount:0,isShared:!1,updateShare:function(){$http.ajax({method:"PUT",url:apiBaseUrl+"public/posts/"+detail.articleId+"/share",headers:{},success:function(){},error:function(res){avalon.illyError("microsite updateShare ajax error",res)},ajaxFail:function(res){avalon.illyError("microsite updateShare ajax failed",res)}})},scrollTop:0,showShareMask:function(){var scrollTop=document.body.scrollTop||document.documentElement.scrollTop;detail.scrollTop=scrollTop,document.body.scrollTop=0,document.documentElement.scrollTop=0;var mask=document.querySelector(".shareMask");setTimeout(function(){mask&&(mask.style.display="block"),mask&&mask.classList.add("a-bounceinB")},16)},hideShareMask:function(){document.body.scrollTop=detail.scrollTop,document.documentElement.scrollTop=detail.scrollTop;var mask=document.querySelector(".shareMask");mask&&mask.classList.remove("a-bounceinB"),setTimeout(function(){mask&&mask.classList.add("a-bounceoutB")},16),setTimeout(function(){mask&&(mask.style.display="none"),mask&&mask.classList.remove("a-bounceoutB")},500)},hasLiked:!1,updateLike:function(){$http.ajax({method:"PUT",url:apiBaseUrl+"public/posts/"+detail.articleId+"/like",headers:{},success:function(){var likeCount=detail.likeCount||0;detail.likeCount=++likeCount},error:function(res){avalon.illyError("microsite updateLike ajax error ",res)},ajaxFail:function(res){avalon.illyError("microsite updateLike ajax failed "+res)}})},like:function(){detail.updateLike(),avalon.setLocalCache(cachedPrefix+detail.articleId+"-like","hasLiked"),detail.hasLiked=!0},fetchData:function(){if(detail.visited&&needCache){var localCache=avalon.getLocalCache(cachedPrefix+detail.articleId);return detail.title=localCache.title,detail.image=resourcePrefix+localCache.image+"?imageView2/2/w/400/h/400",detail.content=localCache.content,detail.createdTime=localCache.createdTime,detail.shareCount=localCache.shareCount,detail.visitCount=localCache.visitCount,void(detail.likeCount=localCache.like)}$http.ajax({url:apiBaseUrl+"public/posts/"+detail.articleId,headers:{},dataType:"json",success:function(json){detail.title=json.title,detail.image=resourcePrefix+json.image+"?imageView2/2/w/400/h/400",detail.content=json.content,detail.createdTime=json.createdTime,detail.shareCount=json.shareCount,detail.visitCount=json.visitCount,detail.likeCount=json.like,avalon.setLocalCache(cachedPrefix+detail.articleId,json),wx.onMenuShareTimeline({title:detail.title,link:avalon.vmodels.site.illy_domain+"/outer/staticArticle.html?id="+detail.articleId,imgUrl:document.querySelector(".cover-img > img").src||document.getElementsByTagName("img")[0].src,success:function(){detail.shareCount++,detail.isShared=!0,detail.updateShare(),detail.hideShareMask()},cancel:function(){detail.isShared||avalon.vmodels.site.showAlert("差一点就分享成功了!",3)}});var appMessageDesc="发现"+avalon.vmodels.site.schoolName+"的这篇<<"+detail.title+">>很赞, 你也瞧瞧~";wx.onMenuShareAppMessage({title:detail.title,link:avalon.vmodels.site.illy_domain+"/outer/staticArticle.html?id="+detail.articleId,desc:appMessageDesc,imgUrl:document.querySelector(".cover-img > img").src||document.getElementsByTagName("img")[0].src,success:function(){avalon.vmodels.site.showAlert("分享成功!",3)},cancel:function(){detail.isShared||avalon.vmodels.site.showAlert("差一点就分享成功了!",3)}})}})}});return avalon.controller(function($ctrl){$ctrl.$onRendered=function(){},$ctrl.$onEnter=function(params){detail.articleId=params.articleId,detail.visited=avalon.vmodels.root.currentIsVisited,detail.isShared=!1,detail.fetchData();var isLiked=avalon.getLocalCache(cachedPrefix+detail.articleId+"-like");"hasLiked"===isLiked?(detail.hasLiked=!0,++detail.likeCount):detail.hasLiked=!1},$ctrl.$onBeforeUnload=function(){},$ctrl.$vmodels=[]})});
//# sourceMappingURL=detail.js.map