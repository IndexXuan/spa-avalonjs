define(["avalon"],function(avalon){void function(){if("addEventListener"in document){var ua=navigator.userAgent,isAndroid=ua.indexOf("Android")>0,isIOS=/iP(ad|hone|od)/.test(ua),rdash=/\(([^)]*)\)/,self=avalon.bindingHandlers.on=function(data,vmodels){var value=data.value,four="$event",eventType=data.param.replace(/-\d+$/,"");if("function"==typeof self[eventType+"Hook"]&&self[eventType+"Hook"](data),value.indexOf("(")>0&&value.indexOf(")")>-1){var matched=(value.match(rdash)||["",""])[1].trim();(""===matched||"$event"===matched)&&(four=void 0,value=value.replace(rdash,""))}else four=void 0;data.hasArgs=four,avalon.parseExprProxy(value,vmodels,data)};self.clickHook=function(data){function resetState(){tapping=!1,avalon(element).removeClass(fastclick.activeClass)}function touchstart(event){doubleIndex++,1===doubleIndex&&(doubleStartTime=Date.now()),tapping=!0,avalon.fastclick.canClick(element)&&avalon(element).addClass(fastclick.activeClass),startTime=Date.now();var touches=event.touches&&event.touches.length?event.touches:[event],e=touches[0];touchStartX=e.clientX,touchStartY=e.clientY}function touchend(event){var touches=event.changedTouches&&event.changedTouches.length?event.changedTouches:event.touches&&event.touches.length?event.touches:[event],e=touches[0],x=e.clientX,y=e.clientY,diff=Date.now()-startTime,dist=Math.sqrt(Math.pow(x-touchStartX,2)+Math.pow(y-touchStartY,2)),canDoubleClick=!1;if(2===doubleIndex&&(doubleIndex=0,canDoubleClick=!0),tapping&&diff<fastclick.clickDuration&&dist<fastclick.dragDistance&&(ghostPrevent=!0,setTimeout(function(){ghostPrevent=!1},fastclick.preventTime),document.activeElement&&document.activeElement!==element&&document.activeElement.blur(),fastclick.canClick(element))){var forElement;"label"===element.tagName.toLowerCase()&&(forElement=element.htmlFor?document.getElementById(element.htmlFor):null),fastclick.focus(forElement?forElement:element),avalon.fastclick.fireEvent(element,"click",event),forElement&&avalon.fastclick.fireEvent(forElement,"click",event),canDoubleClick&&(new Date-doubleStartTime<500&&avalon.fastclick.fireEvent(element,"dblclick",event),doubleIndex=0)}resetState()}var doubleStartTime,startTime,touchStartX,touchStartY,tapping=!1,element=data.element,fastclick=avalon.fastclick,doubleIndex=0;avalon.fastclick.canFix(element)&&(data.specialBind=function(element,callback){element.addEventListener("touchstart",touchstart),element.addEventListener("touchmove",resetState),element.addEventListener("touchcancel",resetState),element.addEventListener("touchend",touchend),element.addEventListener("click",callback)},data.specialUnbind=function(element,callback){element.removeEventListener("touchstart",touchstart),element.removedEventListener("touchmove",resetState),element.removeEventListener("touchcancel",resetState),element.removeEventListener("touchend",touchend),element.removeEventListener("click",callback)})};var ghostPrevent=!1;document.addEventListener("click",function(e){ghostPrevent&&(event.markFastClick||(event.stopPropagation(),event.preventDefault()));var target=e.target;if(target.href&&target.href.match(/#(\w+)/)){var id=RegExp.$1;if(id){document.getElementById(id)}}},!0),avalon.fastclick={activeClass:"ms-click-active",clickDuration:750,dragDistance:14,preventTime:2500,fireEvent:function(element,type,event){var clickEvent=document.createEvent("MouseEvents");clickEvent.initMouseEvent(type,!0,!0,window,1,event.screenX,event.screenY,event.clientX,event.clientY,!1,!1,!1,!1,0,null),clickEvent.markFastClick="司徒正美",element.dispatchEvent(clickEvent)},focus:function(target){if(this.canFocus(target)){var value=target.value;if(target.value=value,isIOS&&target.setSelectionRange&&0!==target.type.indexOf("date")&&"time"!==target.type){var n=value.length;target.setSelectionRange(n,n)}else target.focus()}},canClick:function(target){switch(target.nodeName.toLowerCase()){case"textarea":case"select":case"input":return!target.disabled;default:return!0}},canFocus:function(target){switch(target.nodeName.toLowerCase()){case"textarea":return!0;case"select":return!isAndroid;case"input":switch(target.type){case"button":case"checkbox":case"file":case"image":case"radio":case"submit":return!1}return!target.disabled&&!target.readOnly;default:return!1}},canFix:function(element){if(!touchSupported)return!1;var chromeVersion=+(/Chrome\/([0-9]+)/.exec(ua)||[0,0])[1];if(chromeVersion&&isAndroid){var metaViewport=document.querySelector("meta[name=viewport]");if(metaViewport){if(-1!==metaViewport.content.indexOf("user-scalable=no"))return!1;if(chromeVersion>31&&document.documentElement.scrollWidth<=window.outerWidth)return!1}}return"none"===element.style.msTouchAction?!1:!0}};var IE11touch=navigator.pointerEnabled,IE9_10touch=navigator.msPointerEnabled,touchSupported="ontouchstart"in window||IE9_10touch||IE11touch;touchSupported&&!function(DOC){function W3CFire(el,name,detail){var event=DOC.createEvent("Events");event.initEvent(name,!0,!0),event.fireByAvalon=!0,detail&&(event.detail=detail),el.dispatchEvent(event)}function swipeDirection(x1,x2,y1,y2){return Math.abs(x1-x2)>=Math.abs(y1-y2)?x1-x2>0?"left":"right":y1-y2>0?"up":"down"}function longTap(){touchProxy.last&&(touchProxy.fire("hold"),touchProxy={})}function cancelHold(){clearTimeout(holdTimeout)}function cancelAll(){clearTimeout(touchTimeout),clearTimeout(tapTimeout),clearTimeout(swipeTimeout),clearTimeout(holdTimeout),touchProxy={}}function computeDistance(offsetX,offsetY){return Math.sqrt(Math.pow(offsetX,2)+Math.pow(offsetY,2))}function computeDegree180(offsetX,offsetY){var degree=Math.atan(-1*offsetY/offsetX)/Math.PI*180;return 0>degree?degree+180:degree}function getAngleDiff(offsetX,offsetY){for(var diff=touchProxy.initialAngle-computeDegree180(offsetX,offsetY);Math.abs(diff-rotation)>90;)0>rotation?diff-=180:diff+=180;return rotation=diff}function isPrimaryTouch(event){return("touch"===event.pointerType||event.pointerType===event.MSPOINTER_TYPE_TOUCH)&&event.isPrimary}function isPointerEventType(e,type){return e.type==="pointer"+type||e.type.toLowerCase()==="mspointer"+type}function compute(e,len){var touches=e.touches,len=touches.length,firstTouch=touches[0],otherTouch=touches[1],disX=firstTouch.clientX-otherTouch.clientX,disY=firstTouch.clientY-otherTouch.clientY;return{distance:computeDistance(disX,disY),angel:computeDegree180(disX,disY),rotation:2==len?getAngleDiff(disX,disY):0}}var touchTimeout,tapTimeout,swipeTimeout,holdTimeout,now,firstTouch,_isPointerType,delta,touchProxy={},deltaX=0,deltaY=0,touchNames=[],pinchThreshold=10,rotation=0;touchNames=IE11touch?["pointerdown","pointermove","pointerup","pointercancel"]:IE9_10touch?["MSPointerDown","MSPointerMove","MSPointerUp","MSPointerCancel"]:["touchstart","touchmove","touchend","touchcancel"],DOC.addEventListener(touchNames[0],function(e){if(!(_isPointerType=isPointerEventType(e,"down"))||isPrimaryTouch(e)){firstTouch=_isPointerType?e:e.touches[0],e.touches&&1===e.touches.length&&touchProxy.x2&&(touchProxy.x2=touchProxy.y2=void 0),now=Date.now(),delta=now-(touchProxy.last||now);var el=firstTouch.target;touchProxy.el="tagName"in el?el:el.parentNode,clearTimeout(touchTimeout),touchProxy.x1=firstTouch.pageX,touchProxy.y1=firstTouch.pageY,touchProxy.fire=function(name,detail){W3CFire(this.el,name,detail)};var touches=e.touches;if(touches.length>1){cancelHold(),touchProxy.status=touches.length>2?"pinch":"other",e.preventDefault();var changeInfo=compute(e,touches.length);return touchProxy.distance=changeInfo.distance,void(touchProxy.initialAngle=changeInfo.angel)}delta>0&&250>=delta&&(touchProxy.isDoubleTap=!0),touchProxy.last=now,holdTimeout=setTimeout(longTap,750)}}),DOC.addEventListener(touchNames[1],function(e){if((!(_isPointerType=isPointerEventType(e,"move"))||isPrimaryTouch(e))&&(firstTouch=_isPointerType?e:e.touches[0],cancelHold(),touchProxy.x2=firstTouch.pageX,touchProxy.y2=firstTouch.pageY,deltaX+=Math.abs(touchProxy.x1-touchProxy.x2),deltaY+=Math.abs(touchProxy.y1-touchProxy.y2),e.touches.length>1&&touchProxy.status&&touchProxy.status.match(/other|pinch/g))){var changeInfo=compute(e),changes=touchProxy.distance-changeInfo.distance;if(("pinch"===touchProxy.status||Math.abs(changes)>pinchThreshold)&&(touchProxy.pinch=!0),touchProxy.pinch){var direction=changes>0?"in":"out",name="pinch"!==touchProxy.status?["pinch","pinch"+direction]:[changes>0?"splay":"squeeze"];avalon.each(name,function(i,item){touchProxy.fire(item,{scale:changeInfo.distance/touchProxy.distance,direction:direction})}),touchProxy.distance=changeInfo.distance}"other"===touchProxy.status&&Math.abs(changeInfo.rotation)>5&&(touchProxy.rotate=!0),touchProxy.rotate&&(direction=changeInfo.rotation>0?"cw":"ccw",avalon.each(["rotate","rotate"+direction],function(i,item){touchProxy.fire(item,{deflection:changeInfo.rotation,direction:direction})}),touchProxy.rotation=changeInfo.rotation,touchProxy.initialAngle=changeInfo.angel)}}),DOC.addEventListener(touchNames[2],function(e){if(!(_isPointerType=isPointerEventType(e,"up"))||isPrimaryTouch(e)){cancelHold();var status=touchProxy.status;"other"===status||"pinch"===status?touchProxy={}:touchProxy.x2&&Math.abs(touchProxy.x1-touchProxy.x2)>30||touchProxy.y2&&Math.abs(touchProxy.y1-touchProxy.y2)>30?swipeTimeout=setTimeout(function(){var direction=swipeDirection(touchProxy.x1,touchProxy.x2,touchProxy.y1,touchProxy.y2);touchProxy.fire("swipe",{direction:direction}),touchProxy.fire("swipe"+direction,{direction:direction}),touchProxy={}},0):"last"in touchProxy&&30>deltaX&&30>deltaY?tapTimeout=setTimeout(function(){touchProxy.fire("tap"),touchProxy.isDoubleTap?(touchProxy.fire("doubletap"),touchProxy={}):touchTimeout=setTimeout(function(){touchProxy.fire("singletap"),touchProxy={}},250)},0):touchProxy={},deltaX=deltaY=0}}),touchNames[3]&&DOC.addEventListener(touchNames[3],cancelAll)}(document)}}()});
//# sourceMappingURL=avalon.touch.js.map