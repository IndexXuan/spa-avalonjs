define(["avalon"],function(avalon){function ok(val){return val}function ng(e){throw e}function done(onSuccess){return this.then(onSuccess,ng)}function fail(onFail){return this.then(ok,onFail)}function defer(){var ret={};return ret.promise=new this(function(resolve,reject){ret.resolve=resolve,ret.reject=reject}),ret}function fireCallbacks(promise,fn){if("boolean"==typeof promise.async)var isAsync=promise.async;else isAsync=promise.async=!0;isAsync?window.setTimeout(fn,0):fn()}function _resolve(promise,value){if("pending"===promise._state)if(value&&"function"==typeof value.then){var method=value instanceof msPromise?"_then":"then";value[method](function(val){_transmit(promise,val,!0)},function(reason){_transmit(promise,reason,!1)})}else _transmit(promise,value,!0)}function _reject(promise,value){"pending"===promise._state&&_transmit(promise,value,!1)}function _transmit(promise,value,isResolved){promise._fired=!0,promise._value=value,promise._state=isResolved?"fulfilled":"rejected",fireCallbacks(promise,function(){promise._callbacks.forEach(function(data){promise._fire(data.onSuccess,data.onFail)})})}function _some(any,iterable){iterable=Array.isArray(iterable)?iterable:[];var end,n=0,result=[];return new msPromise(function(resolve,reject){function loop(a,index){a.then(function(ret){end||(result[index]=ret,n++,(any||n>=iterable.length)&&(resolve(any?ret:result),end=!0))},function(e){end=!0,reject(e)})}iterable.length||resolve(result);for(var i=0,l=iterable.length;l>i;i++)loop(iterable[i],i)})}var msPromise=function(executor){this._callbacks=[];var me=this;if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof executor)throw new TypeError("not a function");executor(function(value){_resolve(me,value)},function(reason){_reject(me,reason)})};msPromise.resolve=function(value){return new msPromise(function(resolve){resolve(value)})},msPromise.reject=function(reason){return new msPromise(function(resolve,reject){reject(reason)})},msPromise.prototype={constructor:msPromise,_state:"pending",_fired:!1,_fire:function(onSuccess,onFail){if("rejected"===this._state){if("function"!=typeof onFail)throw this._value;onFail(this._value)}else"function"==typeof onSuccess&&onSuccess(this._value)},_then:function(onSuccess,onFail){if(this._fired){var me=this;fireCallbacks(me,function(){me._fire(onSuccess,onFail)})}else this._callbacks.push({onSuccess:onSuccess,onFail:onFail})},then:function(onSuccess,onFail){onSuccess="function"==typeof onSuccess?onSuccess:ok,onFail="function"==typeof onFail?onFail:ng;var me=this,nextPromise=new msPromise(function(resolve,reject){me._then(function(value){try{value=onSuccess(value)}catch(e){return void reject(e)}resolve(value)},function(value){try{value=onFail(value)}catch(e){return void reject(e)}resolve(value)})});for(var i in me)personal[i]||(nextPromise[i]=me[i]);return nextPromise},done:done,"catch":fail,fail:fail};var personal={_state:1,_fired:1,_value:1,_callbacks:1};msPromise.all=function(iterable){return _some(!1,iterable)},msPromise.race=function(iterable){return _some(!0,iterable)},msPromise.defer=defer,avalon.Promise=msPromise;var nativePromise=window.Promise;return/native code/.test(nativePromise)&&(nativePromise.prototype.done=done,nativePromise.prototype.fail=fail,nativePromise.defer||(nativePromise.defer=defer)),window.Promise=nativePromise||msPromise});
//# sourceMappingURL=mmPromise.js.map