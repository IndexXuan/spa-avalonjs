define(["./mmHistory"],function(){function Router(){var table={};"get,post,delete,put".replace(avalon.rword,function(name){table[name]=[]}),this.routingTable=table}function parseQuery(url){var array=url.split("?"),query={},path=array[0],querystring=array[1];if(querystring)for(var s,seg=querystring.split("&"),len=seg.length,i=0;len>i;i++)seg[i]&&(s=seg[i].split("="),query[decodeURIComponent(s[0])]=decodeURIComponent(s[1]));return{path:path,query:query}}function queryToString(obj){if("string"==typeof obj)return obj;var str=[];for(var i in obj)"query"!=i&&str.push(i+"="+encodeURIComponent(obj[i]));return str.length?"?"+str.join("&"):""}function quoteRegExp(string,pattern,isOptional){var result=string.replace(/[\\\[\]\^$*+?.()|{}]/g,"\\$&");if(!pattern)return result;var flag=isOptional?"?":"";return result+flag+"("+pattern+")"+flag}function supportLocalStorage(){try{return localStorage.setItem("avalon",1),localStorage.removeItem("avalon"),!0}catch(e){return!1}}function escapeCookie(value){return String(value).replace(/[,;"\\=\s%]/g,function(character){return encodeURIComponent(character)})}function setCookie(key,value){var date=new Date;date.setTime(date.getTime()+864e5),document.cookie=escapeCookie(key)+"="+escapeCookie(value)+";expires="+date.toGMTString()}function getCookie(name){var m=String(document.cookie).match(new RegExp("(?:^| )"+name+"(?:(?:=([^;]*))|;|$)"))||["",""];return decodeURIComponent(m[1])}var placeholder=/([:*])(\w+)|\{(\w+)(?:\:((?:[^{}\\]+|\\.|\{(?:[^{}\\]+|\\.)*\})+))?\}/g;if(Router.prototype={error:function(callback){this.errorback=callback},_pathToRegExp:function(pattern,opts){for(var m,name,regexp,segment,keys=opts.keys=[],compiled="^",last=0;m=placeholder.exec(pattern);){name=m[2]||m[3],regexp=m[4]||("*"==m[1]?".*":"string"),segment=pattern.substring(last,m.index);var type=this.$types[regexp],key={name:name};type&&(regexp=type.pattern,key.decode=type.decode),keys.push(key),compiled+=quoteRegExp(segment,regexp,!1),last=placeholder.lastIndex}segment=pattern.substring(last),compiled+=quoteRegExp(segment)+(opts.strict?opts.last:"/?")+"$";var sensitive="boolean"==typeof opts.caseInsensitive?opts.caseInsensitive:!0;return opts.regexp=new RegExp(compiled,sensitive?"i":void 0),opts},add:function(method,path,callback,opts){var array=this.routingTable[method.toLowerCase()];if("/"!==path.charAt(0))throw"path必须以/开头";opts=opts||{},opts.callback=callback,path.length>2&&"/"===path.charAt(path.length-1)&&(path=path.slice(0,-1),opts.last="/"),avalon.Array.ensure(array,this._pathToRegExp(path,opts))},route:function(method,path,query){path=path.trim();for(var el,states=this.routingTable[method],i=0;el=states[i++];){var args=path.match(el.regexp);if(args){el.query=query||{},el.path=path,el.params={};var keys=el.keys;return args.shift(),keys.length&&this._parseArgs(args,el),el.callback.apply(el,args)}}this.errorback&&this.errorback()},_parseArgs:function(match,stateObj){for(var keys=stateObj.keys,j=0,jn=keys.length;jn>j;j++){var key=keys[j],value=match[j]||"";if("function"==typeof key.decode)var val=key.decode(value);else try{val=JSON.parse(value)}catch(e){val=value}match[j]=stateObj.params[key.name]=val}},getLastPath:function(){return getCookie("msLastPath")},setLastPath:function(path){setCookie("msLastPath",path)},redirect:function(hash){this.navigate(hash,{replace:!0})},navigate:function(hash,options){var parsed=parseQuery(("/"!==hash.charAt(0)?"/":"")+hash),options=options||{};"/"===hash.charAt(0)&&(hash=hash.slice(1)),(!avalon.state||options.silent)&&avalon.history&&avalon.history.updateLocation(hash,avalon.mix({},options,{silent:!0})),options.silent||this.route("get",parsed.path,parsed.query,options)},when:function(path,redirect){var me=this,path=path instanceof Array?path:[path];return avalon.each(path,function(index,p){me.add("get",p,function(){var info=me.urlFormate(redirect,this.params,this.query);me.navigate(info.path+info.query,{replace:!0})})}),this},get:function(){},urlFormate:function(url,params,query){var query=query?queryToString(query):"",hash=url.replace(placeholder,function(mat){var key=mat.replace(/[\{\}]/g,"").split(":");return key=key[0]?key[0]:key[1],void 0!==params[key]?params[key]:""}).replace(/^\//g,"");return{path:hash,query:query}},$types:{date:{pattern:"[0-9]{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[1-2][0-9]|3[0-1])",decode:function(val){return new Date(val.replace(/\-/g,"/"))}},string:{pattern:"[^\\/]*"},bool:{decode:function(val){return 0===parseInt(val,10)?!1:!0},pattern:"0|1"},"int":{decode:function(val){return parseInt(val,10)},pattern:"\\d+"}}},"get,put,delete,post".replace(avalon.rword,function(method){return Router.prototype[method]=function(a,b,c){this.add(method,a,b,c)}}),supportLocalStorage()){Router.prototype.getLastPath=function(){return localStorage.getItem("msLastPath")};var cookieID;Router.prototype.setLastPath=function(path){cookieID&&(clearTimeout(cookieID),cookieID=null),localStorage.setItem("msLastPath",path),cookieID=setTimeout(function(){localStorage.removItem("msLastPath")},864e5)}}return avalon.router=new Router,avalon});
//# sourceMappingURL=mmRouter.js.map